---
title: "@kilpi/core"
sidebar:
  order: 1
---

## Core API

### `createKilpi`

Entry point to Kilpi. Create and configure your authorization, subject and policies.

#### Example

```ts
export const Kilpi = createKilpi({
  getSubject,
  policies,
  settings: {
    defaultOnUnauthorized(error) {
      throw new HTTPException(403, error.message);
    },
    disableSubjectCaching: false,
  },
  plugins: [],
});
```

#### Required parameters

- ##### `getSubject: () => Promise<TSubject>`

  Returns the currently authenticated user. [More details](/docs/concepts/subject).

- ##### `policies: Policyset<TSubject>`

  Deeply nested object of policy functions. [More details](/docs/concepts/policy).

#### Optional parameters

- ##### `settings.defaultOnUnauthorized: Function`

  When no handler set in current scope via `Kilpi.onUnauthorized`, this function will be called when a policy throws (e.g. via `Kilpi.authorize` or `Kilpi.unauthorized`).

- ##### `settings.disableSubjectCaching: boolean`

  Disable caching the subject in the current scope. [More details](/docs/concepts/subject#subject-caching).

- ##### `plugins: KilpiPlugin[]`

  List of plugins to extend the functionality of Kilpi. The plugin interfaces will be applied to the returned `KilpiCore` instance. Strongly typed up to 9 plugins. [More details](/docs/concepts/plugin).

#### Generic type parameters

Both parameters are be inferred from `getSubject` and `policies` respectively.

- `TSubject`: Type of subject returned by `getSubject`
- `TPolicyset extends Policyset<TSubject>`: Type of `policies` parameter for strongly typed policies

#### Returns

`KilpiCore<TSubject, TPolicyset>` instance (augmented with plugins).

---

### `KilpiCore`

Constructed by `createKilpi`. This is the main API for interacting with Kilpi.

#### Properties

- ##### Authorizing

  - ##### `Kilpi.getAuthorization(policy, resource?)`

    Authorizes the provided policy and resource and returns a `Promise<Authorization>` which can either be granted as `{ granted: true, subject }` or denied as `{ granted: false, error }`. [More details](/docs/concepts/authorizing).

  - ##### `Kilpi.isAuthorized(policy, resource?)`

    Authorizes the provided policy and resource and returns a `Promise<boolean>`. [More details](/docs/concepts/authorizing).

  - ##### `Kilpi.authorize(policy, resource?)`

    Authorizes the provided policy and resource. Triggers the `onUnauthorized` handler if the authorization fails (or throws). Returns the narrowed down subject. [More details](/docs/concepts/authorizing).

  - ##### `Kilpi.unauthorized()`

    Manually triggers the current `onUnauthorized` handler (or throws `KilpiError)

  - ##### `Kilpi.onUnauthorized(handler)`

    Set an `onUnauthorized` handler for the current scope for when an authorization fails and throws. Requires a [scope](/docs/concepts/scope).

- ##### Protected queries

  - ##### `Kilpi.query(queryFn, options)`

    Constructs a [protected query](/docs/concepts/protected-queries).

  - ##### `Kilpi.filter(policy, resources)`

    Filters the provided resources based on the policy. [More details](/docs/concepts/protected-queries).

- ##### Scope

  - ##### `Kilpi.resolveScope()`

    Utility function to access the current scope if one is available. [Read more about scopes](/docs/concepts/scope).

  - ##### `Kilpi.runInScope(fn)`

    Runs the provided asynchronous function in a new scope. Returns the result of the function. [Read more about scopes](/docs/concepts/scope).

  - ##### `Kilpi.scoped(fn)`

    Similar to `Kilpi.runInScope`, but wraps the function with a new scope to be called later. [Read more about scopes](/docs/concepts/scope).

- ##### Subject

  - ##### `Kilpi.getSubject()`

    Returns the currently authenticated user, with automatic caching (unless disabled via `settings.disableSubjectCaching`) [More details](/docs/concepts/subject).

- ##### Hooks

  - ##### `Kilpi.hooks`

    Exposes the `KilpiHooks` interface for working with [hooks](/docs/concepts/hooks).

- ##### Properties

  - ##### `Kilpi.policies`

    Policies passed to `createKilpi`.

  - ##### `Kilpi.settings`

    Settings passed to `createKilpi`.

- ##### `Kilpi.$$infer`

  Utility type for inferring `TSubject` and `TPolicyset`. Not to be used during runtime.

---

### `KilpiError`

Exposes the internal error types used by Kilpi. Both classes extend the `Error` class.

- `KilpiError.Internal` for internal errors from Kilpi.
- `KilpiError.AuthorizationDenied` for unauthorized errors.

---

### `KilpiHooks`

Exposes the [hooks API for Kilpi](/docs/concepts/hooks). For more details, see the [hooks documentation](/docs/concepts/hooks).

#### Properties

- ##### `onRequestScope`

  Register a new hook for `onRequestScope`

- ##### `onAfterAuthorization`

  Register a new hook for `onAfterAuthorization`

- ##### `registeredHooks`

  List of all registered hooks by type.

---

## Policies

### `deny(narrowedSubject)`

Constructs an `AuthorizationGranted<TNarrowedSubject>` object to be returned from a policy function. Refer to the [policies documentation](/docs/concepts/policy) for more details.

---

### `grant(message?)`

Constructs an `AuthorizationDenied` object to be returned from a policy function. Refer to the [policies documentation](/docs/concepts/policy) for more details.

---

## Plugins

### `createKilpiPlugin`

Constructs a new Kilpi plugin. [Refer to the plugin documentation](/docs/concepts/plugin) for more details.

---

### `EndpointPlugin`

[Refer to the EndpointPlugin documentation](/docs/plugins/endpoint) for more details.

---

### `endpointRequestSchema`

[Refer to the EndpointPlugin documentation](/docs/plugins/endpoint) for more details.

---

### `AuditPlugin`

[Refer to the AuditPlugin documentation](/docs/plugins/audit) for more details.

---

## Other exported utilities

### `getPolicyByKey(policyset, policy)`

Utility to resolve a policy function from a policyset by its key.
