---
title: Authorizing
sidebar:
  order: 1
---

Learn how to authorize and protect actions, pages, mutations, and more in your application.

## Authorization APIs

Using Kilpi, there are several APIs for performing authorizations. They can all be used to protect your application, with slightly different behaviour.

### `Kilpi.isAuthorized`

The simplest way to check for authorizations is to use `Kilpi.isAuthorized`. It returns a `Promise<boolean>` indicating whether the user is authorized or not. Pass it the policy key and a resource, if the policy requires one.

Unlike with `Kilpi.authorize`, you must also handle the unauthorized case manually.

```ts
if (await Kilpi.isAuthorized("documents:create")) {
  await createDocument();
} else {
  // Handle unauthorized here...
}

if (await Kilpi.isAuthorized("documents:delete", document)) {
  await deleteDocument(document.id);
} else {
  // Handle unauthorized here...
}
```

### `Kilpi.authorize`

In some cases, **throwing on unauthorized** is the simplest way to protect your application, e.g. to automatically always throw a 403 error when an authorization check fails.

`Kilpi.authorize` also takes in the policy key and optionally a resource if the policy requires one.

```ts
// Both will throw if not authorized
await Kilpi.authorize("documents:create"); 
await Kilpi.authorize("documents:delete", document); 
```

Instead of the default behaviour (throws a `KilpiError.AuthorizationDenied` error), setup error handling to automatically handle unauthorized errors.

<Steps>
<Step>
#### Setup a global error handler

Start by setting up a global error handler in `createKilpi`.

```ts
export const Kilpi = createKilpi({
  ...,
  defaults: {
    onUnauthorized(error) {
      throw new HTTPException(403, error.message);
    }
  }
}) 

// Will throw a 403 error if not authorized
await Kilpi.authorize("documents:create");
```
</Step>
<Step>
#### Setup a handler for each request (Optional)

For more control over your error handling, you can setup a handler for each request using `Kilpi.onUnauthorized`.

<Aside type="tip">
**The error handler is stored in the [current scope](/docs/concepts/scope)**. A scope is required for `Kilpi.onUnauthorized` (a warning will be shown if no scope is available).

See available installation guides for how to set up a scope for each request using your framework of choice.
</Aside>

```ts {3-5}
export default async function CreateDocumentPage() {
  // Any unauthorized error anywhere on this page should redirect to login
  Kilpi.onUnauthorized((error) => {
    redirect("/login"); // Redirect via throw, e.g. in Next.js
  })

  // Will redirect to login if not authorized
  await Kilpi.authorize("documents:create");

  // ...
}
```
</Step>
</Steps>

### `Kilpi.getAuthorization`

Similarly to `Kilpi.isAuthorized`, `Kilpi.getAuthorization` allows you to manually control your authorizations but returns an **authorization object**, with more data about the result of the authorization check.

For granted authorizations, it contains the **narrowed down** `subject`. For denied authorizations, it contains the `error` message.

```ts
const authorization = await Kilpi.getAuthorization("documents:create");

if (authorization.granted) {
  const user = authorization.subject; 
} else {
  console.error("Unauthorized", authorization.error);
}
```