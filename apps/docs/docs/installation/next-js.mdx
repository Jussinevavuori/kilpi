---
title: Next.js
description: Install Kilpi for Next
---

<Steps>
<Step>
### Install and setup Kilpi

Install Kilpi and setup your Kilpi instance by following the [quickstart guide](/docs/getting-started/quickstart).

```ts
export const Kilpi = createKilpi({ ... })
```

</Step>

<Step>

### Install `ReactServerPlugin`.

Install the `ReactServerPlugin`. It automatically...

1. Caches the subject for you (using `React.cache`).
2. Provides you with React Server Components.
3. Provides you with the `Kilpi.$onUnauthorizedRscAssert` method.

<Tabs syncKey="package-manager">
<Tab label="npm">

```bash
npm install @kilpi/react-server
```

</Tab>
<Tab label="yarn">

```bash
yarn add @kilpi/react-server
```

</Tab>
<Tab label="pnpm">

```bash
pnpm add @kilpi/react-server
```

</Tab>
<Tab label="bun">

```bash
bun add @kilpi/react-server
```

</Tab>
</Tabs>

Apply the plugin in your Kilpi configuration as follows.

```diff lang="ts"
// kilpi.ts
+ import { ReactServerPlugin } from "@kilpi/react-server";

export const Kilpi = createKilpi({
  // ...
+  plugins: [ReactServerPlugin()]
})

+ const { Authorize } = Kilpi.$createReactServerComponents();
```

[Read more about `ReactServerPlugin`](/docs/plugins/react-server) for more details on usage.

</Step>

<Step>
### Handle unauthorized errors from `.assert()`

The `.assert()` method throws an error when authorization is denied.

Since Next.js supports throwing redirections, handling unauthorized exceptions is easiest with a global `onUnauthorizedAssert` handler.

```diff lang="ts"
  export const Kilpi = createKilpi({
    // ...
+   async onUnauthorizedAssert(decision)  {
+     // Optionally customize behavior based on the decision
+     switch (decision.reason) { ... }
+
+     // By default, redirect user
+     redirect("/sign-in");
+   }
  })
```

</Step>

<Step>
### Next steps

Here are some tips on how to best use Kilpi in a Next.js application.

#### 1. Use `<Authorize />` to protect your UI.

Simpe example of protecting your UI.

```tsx
export default async function DashboardPage() {
  return (
    <Authorize policy={Kilpi.always()}>
      <Dashboard />
    </Authorize>
  );
}
```

#### 2. Setup page-specific error handlers.

For example, if you want unauthorized access to `/posts/[id]` to redirect to `/posts`, you can use `Kilpi.$onUnauthorizedRscAssert` as follows.

```tsx {4-8}
export default async function PostPage(props: PageProps) {
  const { id } = await props.params;

  // If any assertion on this page fails, e.g. in
  // `getPost.authorized`, always redirect to `/posts`.
  Kilpi.$onUnauthorizedRscAssert(async (decision) => {
    redirect("/posts");
  });

  // Protected query which uses .assert()
  const post = await getPost.authorized();

  return <PostDetails post={post} />;
}
```

#### 3. Protect your client UI.

See [usage on client](/docs/concepts/usage-on-client) and the [ReactClientPlugin](/docs/plugins/react-client) for more information on protecting your client-side application with the `@kilpi/client` and `@kilpi/react-client` packages.

</Step>
</Steps>
